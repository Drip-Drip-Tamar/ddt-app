---
import Layout from '@layouts/Layout.astro';
import Hero from '@components/Hero.astro';
import TamarStormOverflowMap from '@components/TamarStormOverflowMap.astro';
import TamarStormOverflow from '@components/TamarStormOverflow.astro';
import Cta from '@components/Cta.astro';
import { SOCIAL_LINKS } from '@config/social';

const pageTitle = 'Storm Overflow Map';
const pageDescription = 'Interactive map showing real-time storm overflow activity near Calstock on the River Tamar. Monitor CSO discharges to make informed decisions about water activities.';

// Define the page sections
const heroSection = {
  _type: 'heroSection',
  heading: 'Storm Overflow Map',
  body: 'Monitor real-time Combined Sewer Overflow (CSO) activity within 10km of Calstock. Storm overflows discharge untreated sewage during heavy rainfall. Check this map before swimming, paddling, or other water activities.',
  theme: 'dark' as const
};

const infoSection = {
  _type: 'heroSection',
  heading: 'Understanding the Map',
  body: `**Map Indicators:**
- **⚠️ Red markers**: Currently active overflows discharging into watercourses
- **⚡ Amber markers**: Recent activity (ended within last 5 days)
- **✓ Grey markers**: Inactive or no recent discharge activity

**Why are most markers grey (inactive)?**
Storm overflows typically activate during heavy rainfall when the sewer system exceeds capacity. During dry periods, most or all CSOs will show as inactive. The grey markers show the locations of all storm overflow points so you can be aware of their proximity to your activities.

**Before entering the water:**
1. Check for active (red) markers near your location
2. Review recent rainfall - heavy rain increases overflow risk
3. Consider waiting 48-72 hours after storm events
4. Check our water quality test results on the Results page

**Data Sources:**
- **Base locations**: Rivers Trust EDM Annual Returns 2023 dataset - shows all CSO locations with 2023 spill statistics
- **Live status**: South West Water Event Duration Monitoring (when available) - updates every ~10 minutes
- Each popup shows 2023 historical data including total spill count and duration hours

**Understanding the Statistics:**
The 2023 data in each popup shows:
- **Spill count**: Number of overflow events recorded in 2023
- **Total duration**: Combined hours of all 2023 overflow events
- **Receiving water**: The river or water body receiving any discharge

This historical data helps identify CSOs that activate frequently versus those that rarely discharge.`,
  theme: 'light' as const
};

const dataAttributionSection = {
  _type: 'heroSection',
  heading: 'Data Sources & Attribution',
  body: `This map combines multiple open data sources to provide comprehensive storm overflow information:

**Primary Data Sources:**
- [Rivers Trust EDM Annual Returns 2023](https://theriverstrust.org/key-issues/sewage-in-rivers) - Licensed under CC BY 4.0
- [South West Water Event Duration Monitoring](https://www.southwestwater.co.uk/environment/waterfit/waterfit-live/) - Live data when available
- [Environment Agency Catchment Data Explorer](https://environment.data.gov.uk/catchment-planning/) - Water body classifications

**Data Currency:**
- CSO locations and 2023 statistics are from the most recent annual returns
- Live status updates every 5 minutes when South West Water data is available
- During system maintenance or data unavailability, all CSOs show as inactive (grey)

**Important Notes:**
- The absence of live data doesn't mean overflows aren't occurring - always check recent rainfall
- 2023 statistics provide historical context but may not reflect current year activity
- For official real-time updates, visit [WaterFit Live](https://www.southwestwater.co.uk/environment/waterfit/waterfit-live/)`,
  theme: 'dark' as const
};

const ctaSection = {
  _type: 'ctaSection',
  heading: 'Stay Informed',
  body: 'Check multiple sources before water activities',
  cta: [
    {
      _type: 'actionButton',
      label: 'View Water Quality Results',
      url: '/results',
      theme: 'primary'
    },
    {
      _type: 'actionButton',
      label: 'WaterFit Live Map',
      url: SOCIAL_LINKS.waterfitLive,
      theme: 'secondary'
    }
  ]
};
---

<Layout title={pageTitle} description={pageDescription}>
  <Hero {...heroSection} />
  
  <!-- Interactive Map Section -->
  <TamarStormOverflowMap 
    theme="light" 
    width="full"
  />
  
  <Hero {...infoSection} />
  
  <!-- Activity Chart Section -->
  <TamarStormOverflow 
    theme="light" 
    width="inset"
  />
  
  <Hero {...dataAttributionSection} />
  
  <Cta {...ctaSection} />
</Layout>