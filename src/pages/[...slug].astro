---
import type { Page } from 'types';
import Layout from '@layouts/Layout.astro';
import Cards from '@components/Cards.astro';
import Cta from '@components/Cta.astro';
import Hero from '@components/Hero.astro';
import Logos from '@components/Logos.astro';
import Testimonials from '@components/Testimonials.astro';
import WaterQualityChart from '@components/WaterQualityChart.astro';
import { getPageBySlug } from '@data/page';

// Get slug from params - undefined means homepage
const { slug } = Astro.params;
const slugParam = slug ? (Array.isArray(slug) ? slug.join('/') : slug) : undefined;

// Fetch page data by slug
const pages = await getPageBySlug(slugParam);
const page: Page = pages.length ? pages[0] : null;

// If no page found, return 404
if (!page) {
    return Astro.redirect('/404');
}

const { _id, title, sections, metaTitle, metaDescription, socialImage } = page || {};

const componentMap = {
    cardsSection: Cards,
    ctaSection: Cta,
    heroSection: Hero,
    logosSection: Logos,
    testimonialsSection: Testimonials,
    waterQualitySection: WaterQualityChart
};
---

<Layout title={metaTitle ?? title} description={metaDescription} image={socialImage}>
    <div data-sb-object-id={_id}>
        {sections?.length ? (
            sections.map((section, idx) => {
                const Component = componentMap[section._type];
                return Component ? (
                    <Component {...section} data-sb-field-path={`sections.${idx}`} />
                ) : null;
            })
        ) : (
            <div class="container mx-auto p-8">
                <p>No content available for this page.</p>
            </div>
        )}
    </div>
</Layout>
