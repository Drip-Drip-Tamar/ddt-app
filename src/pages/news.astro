---
import type { SanityDocument } from '@sanity/client';
import Layout from '@layouts/Layout.astro';
import Section from '@components/Section.astro';
import PostListItem from '@components/PostListItem.astro';
import { client as sanityClient } from '@utils/sanity-client';
import { getImageUrl } from '@utils/sanity-image';
import { extractTextFromPortableText } from '@utils/portable-text';

const POSTS_QUERY = `*[
  _type == "post"
  && defined(slug.current)
]|order(publishedAt desc){
  _id,
  title,
  slug,
  excerpt,
  body,
  publishedAt,
  "author": author->name,
  featuredImage {
    image {
      asset,
      "dimensions": asset->metadata.dimensions
    },
    alt
  }
}`;

const posts = await sanityClient.fetch<SanityDocument[]>(POSTS_QUERY);

// Transform posts to card format
const postCards = posts.map((post) => {
    // Use excerpt if available, otherwise extract from body
    const contentSnippet = post.excerpt || extractTextFromPortableText(post.body, 150);

    return {
        _type: 'card',
        heading: post.title,
        body: contentSnippet,
        image: post.featuredImage,
        cta: [
            {
                _type: 'actionLink',
                text: 'Read More',
                url: `/news/${post.slug.current}`
            }
        ],
        badge: post.author
            ? {
                  label: `By ${post.author}`,
                  theme: 'light'
              }
            : undefined
    };
});

const publishedDates = posts.map((post) =>
    post.publishedAt
        ? new Date(post.publishedAt).toLocaleDateString('en-GB', {
              day: 'numeric',
              month: 'short',
              year: 'numeric'
          })
        : ''
);
---

<Layout title="News" addTitleSuffix={true} description="Latest news and updates from Drip Drip Tamar">
    <main class="min-h-screen bg-gray-50">
        {/* Hero section */}
        <div class="bg-white border-b border-gray-200">
            <Section class="text-center py-12 md:py-16">
                <h1 class="text-4xl font-black sm:text-5xl lg:text-6xl mb-4">News</h1>
                <p class="text-lg md:text-xl text-gray-600 max-w-2xl mx-auto">Stay updated with the latest news, updates, and insights from Drip Drip Tamar</p>
            </Section>
        </div>

        {/* Posts section */}
        <Section class="py-8 md:py-12">
            {
                posts.length === 0 ? (
                    <div class="text-center py-12">
                        <p class="text-gray-500">No news posts available yet.</p>
                    </div>
                ) : (
                    <div class="flex flex-col gap-8 max-w-5xl mx-auto">
                        {posts.map((post, idx) => {
                            const contentSnippet = post.excerpt || extractTextFromPortableText(post.body, 200);
                            // Pass image data structure that ResponsiveImage expects
                            const postImage = post.featuredImage?.image?.asset
                                ? {
                                      asset: post.featuredImage.image.asset,
                                      dimensions: post.featuredImage.image.dimensions,
                                      alt: post.featuredImage.alt
                                  }
                                : undefined;

                            return (
                                <PostListItem
                                    title={post.title}
                                    body={contentSnippet}
                                    image={postImage}
                                    author={post.author}
                                    date={publishedDates[idx]}
                                    slug={post.slug.current}
                                    class="w-full"
                                />
                            );
                        })}
                    </div>
                )
            }
        </Section>
    </main>
</Layout>
